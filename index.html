<!DOCTYPE html>
<html>
    <head>
        <title>Mappa dei beni confiscati - Confiscati Bene</title>
	    <meta charset="utf-8" />
    	<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="http://cdnjs.cloudflare.com/ajax/libs/headjs/1.0.3/head.load.min.js"></script>
        <script type="text/javascript">
            head.load("http://d3js.org/queue.v1.min.js")
                .load("http://d3js.org/d3.v3.min.js")
                .load("js/geostats/lib/geostats.min.js")
                .load("js/colorbrewer/colorbrewer.js")
                .load([
                    "http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js", "http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css",
                    "js/spin-control/leaflet.spin.js", "js/spin-control/spin.min.js",
                    "js/osm-geocoder/Control.OSMGeocoder.js", "js/osm-geocoder/Control.OSMGeocoder.css"
                ])
                .load("js/agnes/agnes.js")
                .load("js/filesaver/Blob.js", "js/filesaver/FileSaver.js")
                .load("css/cb.css");

            head.ready(function() {
                var apiPath = '/api/action/datastore/search.json';
                
                /*** Inizializzazione della mappa ***/
                var map = L.map('map');
        	    var southWest = L.latLng(37.118,6.877),
                    northEast = L.latLng(46.826,18.611),
                	bounds = L.latLngBounds(southWest, northEast);
                map.fitBounds(bounds);
                map.options.maxZoom = 15;
        	    map.options.minZoom = 4;
                L.tileLayer (
	    	        'http://{s}.acetate.geoiq.com/tiles/acetate/{z}/{x}/{y}.png',
                    {
        	    	    attribution: 'Acetate tileset from GeoIQ',
                		opacity: .7
		            }
                ).addTo(map);
                map.spin(true);
                /*** ***/

                /*** Gestione dell'infowindow al click ***/
                var info = L.control({position: 'bottomright'});
        		info.onAdd = function (map) {
	        		this._div = L.DomUtil.create('div', 'info');
		        	this.update();
			        return this._div;
        		};
                info.update = function (props) {
                    var that = this;
                    this._div.innerHTML = '<img id="close-cross" src="img/close.png" /><h4>Beni confiscati</h4>';
                    if (props) {
                        var delim = agnes.rowDelimiter(),
                            today = new Date(),
                            stoday = d3.time.format('%Y%m%d')(today),
                            territorio = d3.select("nav#menu-ui a.active").attr("id"),
                            filterKey = data[territorio].id,
                            filterValue = props[geo[territorio].id],
                            imResId = 'e5b4d63a-e1e8-40a3-acec-1d351f03ee56',
                            azResId = '8b7e12f1-6484-47f0-9cf6-88b446297dbc';
                        this._div.innerHTML += '<b>' + 
                            '<span class="rossobc">' + 
                            props[geo[territorio].name] + 
                            '</span>' + 
                            '</b>' + 
                            '<br /><br />';
                        for (var k in props.data) {
                            if (props.data.hasOwnProperty(k) && props.data[k] != '0') {
                                var value = parseInt(props.data[k]);
                                this._div.innerHTML += '<b>' + 
                                    k +
                                    '</b>: ' + 
                                    '<em>' + 
                                    (isNaN(value) ? props.data[k] : value) + 
                                    '</em>'  + 
                                    '<br />';
                            }
                        }
                        this._div.innerHTML += '<br />Scarica l\'elenco degli <a href="#" id="a-immobili">immobili</a> e delle <a href="#" id="a-aziende">aziende</a>.';
                        var imPath = apiPath + 
                            "?resource_id=" + imResId + "&limit=1000&filters[" + 
                            filterKey + 
                            "]=" + 
                            filterValue;
                        d3.select('a#a-immobili').on("click", function() {
                            var that = this;
                            d3.json(imPath, function(err,res) {
                                if (res.result.records.length > 0) {
                                    var csv = agnes.jsonToCsv(res.result.records, delim),
                                        blob = new Blob([csv], {type: "text/csv;charset=utf-8"}),
                                        filename = stoday + '_confiscatibene_immobili_' + filterKey + '-' + filterValue + '.csv';
                                    saveAs(blob, filename);
                                } else {
                                    alert("No data!");
                                }
                            });
                        });
                        var azPath = apiPath + 
                            "?resource_id=i" + azResId + "&limit=1000&filters[" + 
                            filterKey + 
                            "]=" + 
                            filterValue;
                        d3.select('a#a-aziende').on("click", function() {
                            var that = this;
                            d3.json(imPath, function(err,res) {
                                if (res.result.records.length > 0) {
                                    var csv = agnes.jsonToCsv(res.result.records, delim),
                                        blob = new Blob([csv], {type: "text/csv;charset=utf-8"}),
                                        filename = stoday + '_confiscatibene_aziende_' + filterKey + '-' + filterValue + '.csv';
                                    saveAs(blob, filename);
                                } else {
                                    alert("No data!");
                                }
                            });
                        });
                        d3.select(this._div).select("img#close-cross")
                            .style("display", "block")
                            .on("click", function() {
                                info.update();
                            });
                    } else {
                        this._div.innerHTML += 'Mouse su un poligono';
                        d3.select(this._div).select("img#close-cross").style("display", "none");
                    }
    		    };
                info.addTo(map);
                /*** ***/

                /*** Creazione del men√π dei livelli ***/
                var menu = L.control({position: 'topleft'});
                menu.onAdd = function(map) {
                    var nav = L.DomUtil.create('nav', 'menu-ui');
                    nav.setAttribute('id','menu-ui');
                    return nav;
                };
                menu.addTo(map);
                /*** ***/

                /*** Stile dei livelli ***/
                function getColor(d, bins) {
                    for (var i=1; i<bins.length; i++) {
                        if (d <= bins[i]) {
                            return colorbrewer.Reds[bins.length-1][i-1];
                        }
                    }
                }

        		function style(feature) {
                    var territorio = d3.select("nav#menu-ui a.active").attr("id");
	        		return {
		        		weight: 0.3,
			        	opacity: 1,
				        color: 'white',
    				    fillOpacity: 0.7,
    	    			fillColor: getColor(parseInt(feature.properties.data[data[territorio].binCol]), data[territorio].bins)
		    	    };
        		}

                /*** Gestione degli eventi ***/
                var geojson;

	        	function highlightFeature(e) {
		        	var layer = e.target;
    		    	layer.setStyle({
    			    	weight: 5,
	    			    color: '#666',
    	    			dashArray: '',
	    	    		fillOpacity: 0.7
		    	    });

        			if (!L.Browser.ie && !L.Browser.opera) {
	        			layer.bringToFront();
		        	}

    		    	//info.update(layer.feature.properties);
    	    	}
                
                function resetHighlight(e) {
    		    	geojson.resetStyle(e.target);
	    		    //info.update();
    	    	}

	    	    function zoomToFeature(e) {
		    	    //map.fitBounds(e.target.getBounds());
		        	var layer = e.target;
    		    	info.update(layer.feature.properties);
        		}

	        	function onEachFeature(feature, layer) {
		        	layer.on({
			        	mouseover: highlightFeature,
				        mouseout: resetHighlight,
    				    click: zoomToFeature
    	    		});
	    	    }
                
                geojson = L.geoJson("", {
    	    		style: style,
	    	    	onEachFeature: onEachFeature
    	    	}).addTo(map);
                /*** ***/

                /*** Funzione di ricerca del luogo ***/
                var osmGeocoder = new L.Control.OSMGeocoder(
                    { 
                        collapsed: false, 
                        position: 'topleft',
                        text: 'Cerca luogo'
                    }
                );
                map.addControl(osmGeocoder);
                /*** ***/

                /*** Legenda ***/
    		    var legend = L.control({position: 'bottomleft'});
    	    	legend.onAdd = function (map) {
                    this._div = L.DomUtil.create('div', 'info legend');
                    this._div.innerHTML = '<h4>Legenda</h4>';
			        return this._div;
                };
                legend.update = function(territorio) {
                    var grades = data[territorio].ranges;
                    this._div.innerHTML = '<h4>Legenda</h4>';
                    for (var i=0; i<grades.length; i++) {
                        this._div.innerHTML += '<i style="background:' + colorbrewer.Reds[grades.length][i] + '"></i> ' + grades[i] + '<br />';
    			    }
    	    	};
                legend.addTo(map);
                /*** ***/

                /*** Gestione dei dati ***/
                var geo = {
                        'comuni': { id: 'PRO_COM', name: 'NOME', resource: null },
                        'province': { id: 'COD_PRO', name: 'NOME', resource: null },
                        'regioni': { id: 'COD_REG', name: 'NOME', resource: null }
                    },
                    data = {
                        'comuni': { id: 'IdComuneISTAT', resourceId: '69b2565e-0332-422f-ad57-b11491e33b08', resource: null, binCol: 'Totale beni', bins: [], ranges: [] },
                        'province': { id: 'IdProvinciaISTAT', resourceId: 'c18fa1ca-971f-4cfa-92e9-869785260dec', resource: null, binCol: 'Totale beni', bins: [], ranges: [] },
                        'regioni': { id: 'IdRegioneISTAT', resourceId: 'e2f0c989-929f-4e4d-87e2-097140f8880f', resource: null, binCol: 'Totale beni', bins: [], ranges: [] }
                    };

                // Selettore dei livelli
                d3.select("nav#menu-ui").selectAll("a")
                    .data(d3.keys(geo).sort(d3.descending))
                    .enter()
                    .append("a")
                    .attr("href", "#")
                    .attr("id", function(d) { return d; })
                    .on("click", function(d) {
	    		        info.update();
                        loadData(d);
                    })
                    .text(function(d) { return d; });

                // Join tra dati e territori
                function joinData(territorio) {
                    var numGeo = geo[territorio].resource.features.length,
                        numData = data[territorio].resource.result.records.length,
                        noData = true, numOkData = 0, numNoData = 0;
                    for (var i=0; i<geo[territorio].resource.features.length; i++) {
                        var geoID = geo[territorio].resource.features[i].properties[geo[territorio].id];
                        for (var j=0; j<numData; j++) {
                            var dataID = data[territorio].resource.result.records[j][data[territorio].id];
                            if (dataID == geoID) {
                                numOkData++;
                                geo[territorio].resource.features[i].properties.data = data[territorio].resource.result.records[j];
                                noData = false;
                                break;
                            }
                        }
                        if (noData) {
                            numNoData++;
                            geo[territorio].resource.features.splice(i,1);
                            i--;
                        } else {
                            noData = true;
                        }
                    }
                }

                // Binning della distribuzione dei dati
                function binData(territorio) {
                    var serie = data[territorio].resource.result.records.map(function(el) { return parseInt(el[data[territorio].binCol]); });
                    var gs = new geostats(serie);
                    data[territorio].bins = gs.getJenks(7);
                    data[territorio].ranges = gs.ranges;
                    legend.update(territorio);
                }

                function loadData(territorio) {
                    d3.selectAll("nav#menu-ui a").classed("active", false);
                    d3.select("nav#menu-ui a#"+territorio).classed("active", true);
                    geojson.clearLayers();
                    if (!geo[territorio].resource || !data[territorio].resource) {
                        var limit = 2000;
        		        map.spin(true);
                        queue()
                            .defer(d3.json, 'geo/'+territorio+'.js') // Geojson
                            .defer(d3.json, apiPath + '?resource_id=' + data[territorio].resourceId + '&limit=' + limit) // Dati
                            .await(function(err, geojs, datajs) {
                                geo[territorio].resource = geojs;
                                data[territorio].resource = datajs;
                                var allData = [datajs.result.records],
                                    div = parseInt(datajs.result.total) / datajs.result.limit;
                                if (div > 1) { // Paginazione dei risultati
                                    var q = queue();
                                    limit = datajs.result.limit;
                                    for (var n=1; n < div; n++) {
                                        q.defer(d3.json, apiPath + '?resource_id=' + data[territorio].resourceId + '&limit=' + limit + '&offset=' + (n*limit));
                                    }
                                    q.await(function() {
                                        for (var i=1; i<arguments.length; i++) {
                                            allData.push(arguments[i].result.records);
                                        }
                                        data[territorio].resource.result.records = d3.merge(allData);
			                            map.spin(false);
                                        joinData(territorio);
                                        binData(territorio);
	            	    	            geojson.addData(geo[territorio].resource);
                                    });
                                } else {
    			                    map.spin(false);
                                    joinData(territorio);
                                    binData(territorio);
	        	    	            geojson.addData(geo[territorio].resource);
                                }
                            });
                    } else {
		    	        geojson.addData(geo[territorio].resource);
                    }
                }
                /*** ***/

                /*** Caricamento dei dati di default ***/
                setTimeout(function () {
	    		    map.spin(false);
                    loadData('regioni');
                }, 3000);
                /*** ***/

            });

        </script>
    </head>
    <body>
        <div id="map"></div>
        <a href="https://github.com/jenkin/confiscatibene-choropleth"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
    </body>
</html>

