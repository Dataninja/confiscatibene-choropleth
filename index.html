<!DOCTYPE html>
<html>
    <head>
        <title>Mappa dei beni confiscati - Confiscati Bene</title>
	    <meta charset="utf-8" />
    	<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="img/favicon.gif" />
        <meta property="og:site_name" content="Confiscati Bene" />
        <meta property="og:locale" content="it_it" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="Confiscati Bene" />
        <meta property="og:url" content="http://www.confiscatibene.it" />
        <meta property="og:description" content="Confiscati Bene è un progetto partecipativo per favorire la trasparenza, il riuso e la valorizzazione dei beni confiscati alle mafie, attraverso la raccolta, l'analisi dei dati e il monitoraggio dei beni stessi. Alla sua costruzione e implementazione partecipano giornalisti, attivisti e tecnologi: ognuno di noi mette a disposizione la propria specifica competenza per rispondere ad alcune domande sullo stato e sulla gestione dei beni confiscati in Italia alla criminalità organizzata: Quanti sono? Dove sono? Quanto valgono? Come vengono riutilizzati?" />
        <meta property="og:image" content="http://viz.confiscatibene.it/anbsc/choropleth/img/logocb.png" />
        <script src="js/head/head.min.js"></script>
        <script type="text/javascript">
            //var JSTERS = {};
            var MYDEBUG;
            head.load("js/queue/queue.v1.min.js")
                .load("js/d3/d3.v3.min.js")
                .load("js/geostats/geostats.min.js")
                .load("js/colorbrewer/colorbrewer.js")
                .load([
                    "js/leaflet/leaflet.js", "js/leaflet/leaflet.css",
                    "js/spin-control/leaflet.spin.js", "js/spin-control/spin.min.js",
                    "js/osm-geocoder/Control.OSMGeocoder.js", "js/osm-geocoder/Control.OSMGeocoder.css",
                    "js/label/leaflet.label.js", "js/label/leaflet.label.css",
                    "js/fullscreen/Control.FullScreen.js", "js/fullscreen/Control.FullScreen.css"
                ])
                .load("js/completely/complete.ly.1.0.1.js")
                .load("js/agnes/agnes.js")
                .load("js/argjs/arg-min.js")
                .load("js/filesaver/Blob.js", "js/filesaver/FileSaver.js")
                .load("css/cb.css", "css/table.css");

            head.ready(function() {
                var apiPath = '/api/confiscatibene/action/datastore/search.json';
                
                /*** Gestione dei dati ***/
                var defaultGeo = {
                        'regioni': { id: 'COD_REG', name: 'NOME_REG', resource: null, list: [] },
                        'province': { id: 'COD_PRO', name: 'NOME_PRO', resource: null, list: [] },
                        'comuni': { id: 'PRO_COM', name: 'NOME_COM', resource: null, list: [] }
                    },
                    defaultData = {
                        'regioni': { id: 'IdRegioneISTAT', resourceId: 'e2f0c989-929f-4e4d-87e2-097140f8880f', resource: null, binCol: 'Totale beni', bins: [], ranges: [] },
                        'province': { id: 'IdProvinciaISTAT', resourceId: 'c18fa1ca-971f-4cfa-92e9-869785260dec', resource: null, binCol: 'Totale beni', bins: [], ranges: [] },
                        'comuni': { id: 'IdComuneISTAT', resourceId: '69b2565e-0332-422f-ad57-b11491e33b08', resource: null, binCol: 'Totale beni', bins: [], ranges: [] }
                    },
                    geo = {}, data = {};

                // Parametri dell'URL
                /* ie. http://viz.confiscatibene.it/anbsc/choropleth/?ls[0]=regioni&ls[1]=province&ls[2]=comuni&dl=regioni&t=1
                    {
                        ls: Array(), // Livelli caricati: regioni, province, comuni
                        dl: [string], // Livello mostrato al caricamento (e a cui eventualmente si riferisce t)
                        t: [int], // Codice istat del territorio centrato e con infowindow aperta
                        i: [int] // Codice istat del territorio con infowindow aperta
                    }
                */
                var parameters = Arg.query();
                //console.log(parameters);
                parameters.ls = parameters.ls || d3.keys(defaultGeo);
                parameters.ml = parameters.ls[0];
                parameters.dl = parameters.fl || parameters.dl || parameters.ml;
                parameters.md = parameters.md || (head.mobile ? 'mobile' : '');
                d3.select('body').classed(parameters.md,true);
                if (parameters.t) {
                    parameters.ls = parameters.ls.slice(parameters.ls.indexOf(parameters.dl)+1);
                    parameters.fl = parameters.dl;
                    parameters.dl = parameters.ml = parameters.ls[0];
                }
                
                // Livelli disponibili da parametri dell'URL
                for (var i=0; i<parameters.ls.length; i++) {
                    if (defaultGeo.hasOwnProperty(parameters.ls[i]) && defaultData.hasOwnProperty(parameters.ls[i])) {
                        geo[parameters.ls[i]] = defaultGeo[parameters.ls[i]];
                        data[parameters.ls[i]] = defaultData[parameters.ls[i]];
                    }
                }
                if (parameters.t) { parameters.ls.unshift(parameters.fl); }
                /*** ***/

                /*** Inizializzazione della mappa ***/
                var map = L.map('map',{ maxZoom: 15, minZoom: 4, scrollWheelZoom: true });
        	    var southWest = L.latLng(37.118,6.877),
                    northEast = L.latLng(46.826,18.611),
                	bounds = L.latLngBounds(southWest, northEast);
                map.fitBounds(bounds);
                L.tileLayer (
	    	        'http://{s}.acetate.geoiq.com/tiles/acetate/{z}/{x}/{y}.png',
                    {
                        attribution: 'Acetate tileset from <a href="http://www.geoiq.com/" target="_blank">GeoIQ</a> | ' + 
                        'Icons designed by <a href="http://www.flaticon.com/" target="_blank">Flaticon.com</a> and <a href="http://www.simplesharebuttons.com/" target="_blank">Simple Share Buttons</a> | ' + 
                        'Fork me on <a href="https://github.com/Dataninja/confiscatibene-choropleth" target="_blank">GitHub</a>',
                		opacity: .7
		            }
                ).addTo(map);
                map.spin(true);
                /*** ***/

                /*** Gestione dell'infowindow al click ***/
                var info;
                if (parameters.md === 'widget') {
                    info = {};
                    info._div = d3.select('body').append('div').attr('id','infowindow').node();
                } else {
                    info = L.control({position: 'bottomright'});
                    info.onAdd = function (map) {
                        this._div = L.DomUtil.create('div', 'info '+parameters.md);
                        this._div.setAttribute('id','infowindow');
                        this._div.setAttribute('style','max-height:'+(head.screen.innerHeight-90)+'px;');
                        d3.select(this._div)
                            .on("mouseenter", function() {
                                map.scrollWheelZoom.disable();
                            })
                            .on("mouseleave", function() {
                                map.scrollWheelZoom.enable();
                            });
    		        	this.update();
	    		        return this._div;
                    };
                }
                info.update = function (props) {
                    var that = this;
                    this._div.innerHTML = '';
                    if (props) {
                        if (parameters.md === 'mobile') map.dragging.disable();
                        var delim = agnes.rowDelimiter(),
                            today = new Date(),
                            stoday = d3.time.format('%Y%m%d')(today),
                            territorio = parameters.dl,
                            filterKey = data[territorio].id,
                            filterValue = props[geo[territorio].id],
                            imResId = 'e5b4d63a-e1e8-40a3-acec-1d351f03ee56',
                            azResId = '8b7e12f1-6484-47f0-9cf6-88b446297dbc';

                        var btnTitle = 'Condividi la situazione' + (territorio == 'regioni' ? ' in ' : ' a ') + props[geo[territorio].name];
                        var buttons = [
                            '<a class="ssb" href="http://twitter.com/share?url=http://viz.confiscatibene.it' + 
                                encodeURIComponent(Arg.url(parameters)) + 
                                '&text=' + encodeURIComponent("Gli immobili e le aziende #confiscatibene di "+props[geo[territorio].name]+" via @confiscatibene") + 
                                '" target="_blank" title="'+btnTitle+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>',
                            '<a class="ssb" href="http://www.facebook.com/sharer.php?u=http://viz.confiscatibene.it' + 
                                encodeURIComponent(Arg.url(parameters)) + 
                                '" target="_blank" title="'+btnTitle+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>',
                            '<a class="ssb" href="https://plus.google.com/share?url=http://viz.confiscatibene.it' + 
                                encodeURIComponent(Arg.url(parameters)) + 
                                '" target="_blank" title="'+btnTitle+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>',
                            '<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url=http://viz.confiscatibene.it' + 
                                encodeURIComponent(Arg.url(parameters)) + 
                                '" target="_blank" title="'+btnTitle+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>',
                            '<a class="ssb" href="mailto:?Subject=Confiscati Bene a ' + 
                                encodeURIComponent(props[geo[territorio].name]) + 
                                '&Body=Gli immobili e le aziende %23confiscatibene di ' + 
                                encodeURIComponent(props[geo[territorio].name]) + 
                                ': http://viz.confiscatibene.it' + 
                                encodeURIComponent(Arg.url(parameters)) + 
                                '" target="_blank" title="'+btnTitle+' per email"><img src="img/email.png" id="ssb-email"></a>'
                        ];

                        var dnlBtn = [
                            '<a id="a-immobili" class="dnl" href="#" title="Scarica l\'elenco degli immobili"><img src="img/house109-dnl.png" /></a>',
                            '<a id="a-aziende" class="dnl" href="#" title="Scarica l\'elenco delle aziende"><img src="img/factory6-dnl.png" /></a>'
                        ];

                        var table = '<table class="zebra">' + 
                            '<thead>' + 
                            '<tr>' + 
                            '<th>' + dnlBtn.join("&nbsp;") + "&nbsp;&nbsp;" + buttons.join("&nbsp;") + '</th>' + 
                            '<th style="text-align:right;"><a id="close-cross" href="#" title="Chiudi"><img src="img/close.png" /></a></th></tr>' + 
                            '<tr>' + 
                            '<th colspan="2" class="rossobc">' + props[geo[territorio].name] + '</th>' +
                            '</tr>' + 
                            '</thead>' + 
                            '<tfoot>' + 
                            '<tr><td colspan="2" style="text-align:right;font-size: smaller;">' + 
                            'Creative Commons Attribution <a href="http://creativecommons.org/licenses/by/3.0/it/" target="_blank">CC-BY 3.0 Italia</a>' + 
                            '</td></tr>' + 
                            '</tfoot>' + 
                            '<tbody>';

                        for (var k in props.data) {
                            if (props.data.hasOwnProperty(k) && props.data[k] != '0' && k.charAt(0) == k.charAt(0).toUpperCase() && k.slice(0,2) != "Id") {
                                table += '<tr>' + 
                                    '<td>' + (k.indexOf('Totale') > -1 ? '<b>'+k+'</b>' : k) + '</td>' +
                                    '<td>' + (k.indexOf('Totale') > -1 ? '<b>'+parseInt(props.data[k])+'</b>' : (parseInt(props.data[k]) || props.data[k])) + '</td>' + 
                                    '</tr>';
                            }
                        }

                        table += '</tbody></table>';

                        this._div.innerHTML += table;

                        var imPath = apiPath + 
                            "?resource_id=" + imResId + "&limit=5000&filters[" + 
                            filterKey + 
                            "]=" + 
                            filterValue;
                        d3.select('a#a-immobili').on("click", function() {
                            var that = this;
                            d3.json(imPath, function(err,res) {
                                if (res.result.records.length > 0) {
                                    var csv = agnes.jsonToCsv(res.result.records, delim),
                                        blob = new Blob([csv], {type: "text/csv;charset=utf-8"}),
                                        filename = stoday + '_confiscatibene_immobili_' + filterKey + '-' + filterValue + '.csv';
                                    saveAs(blob, filename);
                                } else {
                                    alert("No data!");
                                }
                            });
                        });
                        var azPath = apiPath + 
                            "?resource_id=i" + azResId + "&limit=5000&filters[" + 
                            filterKey + 
                            "]=" + 
                            filterValue;
                        d3.select('a#a-aziende').on("click", function() {
                            var that = this;
                            d3.json(imPath, function(err,res) {
                                if (res.result.records.length > 0) {
                                    var csv = agnes.jsonToCsv(res.result.records, delim),
                                        blob = new Blob([csv], {type: "text/csv;charset=utf-8"}),
                                        filename = stoday + '_confiscatibene_aziende_' + filterKey + '-' + filterValue + '.csv';
                                    saveAs(blob, filename);
                                } else {
                                    alert("No data!");
                                }
                            });
                        });
                        d3.select(this._div).select("a#close-cross")
                            .on("click", function() {
                                geojson.eachLayer(function(l) { l.highlight = false; geojson.resetStyle(l); });
                                delete parameters.i;
                                info.update();
                                return false;
                            });
                    } else {
                        if (parameters.md === 'mobile') map.dragging.enable();
                        this._div.innerHTML += 'Mouse su un poligono';
                    }
    		    };
                if (parameters.md === 'widget') {
                    info.update();
                } else {
                    info.addTo(map);
                }
                /*** ***/

                /*** Fullscreen ***/
                var fullscreen = L.control.fullscreen({title: 'Fullscreen mode'}).addTo(map);
                /*** ***/

                /*** Logo ***/
                var logo;
                if (parameters.md === 'widget') {
                    logo = d3.select('body').insert('div','#map').attr('id','logo-widget')
                        .append('a').classed('logo '+parameters.md, true)
                        .attr('href','http://www.confiscatibene.it/')
                        .attr('target','_blank')
                        .append('img')
                        .attr('id','logo')
                        .attr('src','img/logocb.png');
                } else {
                    logo = L.control({position: 'topleft'});
                    logo.onAdd = function(map) {
                        var a = L.DomUtil.create('a','logo '+parameters.md),
                            img = L.DomUtil.create('img','logo',a);
                        a.setAttribute('href','http://www.confiscatibene.it/');
                        a.setAttribute('target','_blank');
                        img.setAttribute('id','logo');
                        img.setAttribute('src','img/logocb.png');
                        return a;
                    };
                    logo.addTo(map);
                }
                /*** ***/

                /*** Pulsante di reset ***/
                var reset = L.control({position: (parameters.md === 'mobile' ? 'bottomleft' : 'topright')});
                reset.onAdd = function(map) {
                    var img = L.DomUtil.create('img', 'reset '+parameters.md);
                    img.setAttribute('src','img/reset.png');
                    img.setAttribute('title','Reset');
                    d3.select(img).on('click', function() {
                        loadData(parameters.ml);
                        map.fitBounds(geojson.getBounds());
                    });
                    return img;
                };
                reset.addTo(map);
                /*** ***/

                /*** Pulsante di embed ***/
                var embedTextArea = L.control({position: (parameters.md === 'mobile' ? 'bottomleft' : 'topright')});
                embedTextArea.onAdd = function(map) {
                    var textarea = L.DomUtil.create('textarea', 'embed-textarea '+parameters.md),
                        oldMd = parameters.md;
                    parameters.md = 'embed';
                    var iframe = '<iframe src="http://'+location.hostname+Arg.url(parameters)+'" frameborder="0" allowtransparency="true" ' + 
                            'allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen ' + 
                            'width="100%" height="700"></iframe>';
                    parameters.md = oldMd;
                    textarea.value = iframe;
                    d3.select(textarea).on('click', function() {
                        this.select();
                    });
                    return textarea;
                };

                var embed = L.control({position: (parameters.md === 'mobile' ? 'bottomleft' : 'topright')});
                embed.onAdd = function(map) {
                    var img = L.DomUtil.create('img', 'embed '+parameters.md),
                        added = false;
                    img.setAttribute('src','img/embed.png');
                    img.setAttribute('title','Embed this map');
                    d3.select(img).on('click', function() {
                        if (!added) {
                            embedTextArea.addTo(map);
                            embedTextArea.getContainer().select();
                            added = true;
                        } else {
                            embedTextArea.removeFrom(map);
                            added = false;
                        }
                    });
                    return img;
                };
                embed.addTo(map);
                /*** ***/

                /*** Detach map ***/
                if (parameters.md === 'embed' || parameters.md === 'widget') {
                    var detach = L.control({position: 'topright'});
                    detach.onAdd = function(map) {
                        var a = L.DomUtil.create('a','detach '+parameters.md),
                            img = L.DomUtil.create('img','detach',a);
                        a.setAttribute('href',Arg.url(parameters));
                        a.setAttribute('target','_blank');
                        a.setAttribute('title','Open in new window');
                        img.setAttribute('id','detach');
                        img.setAttribute('src','img/detach.png');
                        d3.select(a).on('click', function () {
                            this.setAttribute('href',Arg.url(parameters));
                        });
                        return a;
                    };
                    detach.addTo(map);
                }
                /*** ***/

                /*** Pulsanti di condivisione ***/
                if (!parameters.md) {
                    var share = L.control({position: 'bottomleft'});
                    share.onAdd = function(map) {
                        var div = L.DomUtil.create('div','share '+parameters.md);
                        div.setAttribute('id','buttons');
                        var twitter = '<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://confiscatibene.it/it/mappe/" data-via="confiscatibene" data-lang="it" data-related="confiscatibene" data-hashtags="confiscatibene" data-count="vertical">Tweet</a>';
                        var facebook = '<div class="fb-like" data-href="http://confiscatibene.it/it/mappe/" data-layout="box_count" data-action="like" data-show-faces="false" data-share="false"></div>';
                        var gplus = '<div class="g-plusone" data-size="tall" data-href="http://confiscatibene.it/it/mappe/" data-annotation="bubble"></div>';
                        div.innerHTML = twitter + facebook + gplus;
                        head.load("https://platform.twitter.com/widgets.js")
                            .load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId=470290923072583&version=v2.0") // appID di Dataninja
                            .load("https://apis.google.com/js/plusone.js");
                        return div;
                    };
                    share.addTo(map);
                }
                /*** ***/

                /*** Creazione del menù dei livelli ***/
                var menu = L.control({position: 'topleft'});
                menu.onAdd = function(map) {
                    var nav = L.DomUtil.create('nav', 'menu-ui '+parameters.md);
                    nav.setAttribute('id','menu-ui');
                    if (parameters.md === 'widget') nav.setAttribute('style','display:none;');
                    return nav;
                };
                menu.addTo(map);
                /*** ***/

                /*** Stile dei livelli ***/
                var defaultStyle = {
		        		weight: 0.5,
			        	opacity: 1,
				        color: 'white',
    				    fillOpacity: 0.7,
    	    			fillColor: 'none'
		    	    },
    			    highlightStyle = {
                        weight: 2,
                        color: '#666'
                    };

                function getColor(d, bins) {
                    for (var i=1; i<bins.length; i++) {
                        if (d <= bins[i]) {
                            return colorbrewer.Reds[bins.length-1][i-1];
                        }
                    }
                }

        		function style(feature) {
                    var territorio = parameters.dl,
                        currentStyle = defaultStyle;
                    currentStyle.fillColor = getColor(parseInt(feature.properties.data[data[territorio].binCol]), data[territorio].bins);
	        		return currentStyle;
        		}

                /*** Funzione di ricerca del luogo ***/
                if (parameters.md != 'widget' && parameters.md != 'mobile') {
                    var osmGeocoder = new L.Control.OSMGeocoder(
                        { 
                            collapsed: true, 
                            position: 'topleft',
                            text: 'Cerca il tuo comune',
                            bounds: bounds,
                            email: "info@confiscatibene.it",
                            callback: function (results) {
                                if (results.length) {
                                    var bbox = results[0].boundingbox,
                                        first = new L.LatLng(bbox[0], bbox[2]),
                                        second = new L.LatLng(bbox[1], bbox[3]),
                                        bounds = new L.LatLngBounds([first, second]);
                                    delete parameters.i;
    	    	    	            info.update();
                                    loadData('comuni');
                                    this._map.fitBounds(bounds, {maxZoom:12});
                                }
                            }
                        }
                    );
                    map.addControl(osmGeocoder);
                    osmGeocoder._completely = completely(osmGeocoder._input);
                    osmGeocoder._completely.onChange = function (text) {
                        osmGeocoder._completely.startFrom = text.lastIndexOf(' ')+1;
                        osmGeocoder._completely.repaint();
                    };
                    osmGeocoder._completely.input.maxLength = 50; // limit the max number of characters in the input text 
                    d3.json((parameters.t ? 'geo/lista_comuni-'+parameters.t+'.json' : 'geo/lista_comuni.json'), function(err,data) {
                        defaultGeo['comuni'].list = data;
                        osmGeocoder._completely.options = defaultGeo['comuni'].list.map(function(el) { return el[geo['comuni'].name]; });
                    });
                }
                /*** ***/

                /*** Gestione degli eventi ***/
                var geojson, label = new L.Label();

	        	function highlightFeature(e) {
                    var layer = e.target,
                        props = layer.feature.properties;
                    
                    label.setContent(props[geo[parameters.dl].name]+'<br>Beni confiscati: '+props.data[data[parameters.dl].binCol]);
                    label.setLatLng(layer.getBounds().getCenter());
                    map.showLabel(label);
    	    	}
                
                function resetHighlight(e) {
                    var layer = e.target;
                    label.close();
    	    	}

	    	    function openInfoWindow(e, layer) {
                    var layer = layer || e.target;
                    geojson.eachLayer(function(l) { l.highlight = false; geojson.resetStyle(l); });
                    layer.highlight = true;
                    layer.setStyle(highlightStyle);
                    parameters.i = layer.feature.properties[geo[parameters.dl].id];
                    info.update(layer.feature.properties);
                    if (!L.Browser.ie && !L.Browser.opera) {
	        			layer.bringToFront();
    	        	}
        		}

	        	function onEachFeature(feature, layer) {
		        	layer.on({
			        	mouseover: highlightFeature,
				        mouseout: resetHighlight,
    				    click: openInfoWindow
    	    		});
	    	    }
                geojson = L.geoJson("", {
    	    		style: style,
	    	    	onEachFeature: onEachFeature
    	    	}).addTo(map);
                /*** ***/

                /*** Legenda ***/
    		    var legend = L.control({position: 'bottomleft'});
    	    	legend.onAdd = function (map) {
                    this._div = L.DomUtil.create('div', 'info legend '+parameters.md);
                    this._div.innerHTML = '<h4>Legenda</h4>';
			        return this._div;
                };
                legend.update = function(territorio) {
                    var grades = data[territorio].ranges;
                    this._div.innerHTML = (parameters.md != 'widget' ? '<h4 title="Numero totale di beni confiscati">Legenda</h4>' : '');
                    for (var i=0; i<grades.length; i++) {
                        this._div.innerHTML += '<i title="Tra ' + grades[i].replace("-","e") + ' beni confiscati" style="background:' + 
                            colorbrewer.Reds[grades.length][i] + '"></i> ' + 
                            (parameters.md != 'widget' ? grades[i] : '') + '<br>';
                    }
                    if (parameters.md != 'widget') this._div.innerHTML += '<br>Numero totale<br>di beni confiscati';
    	    	};
                legend.addTo(map);
                /*** ***/

                // Selettore dei livelli
                d3.select("nav#menu-ui").selectAll("a")
                    .data(d3.keys(defaultGeo))
                    .enter()
                    .append("a")
                    .attr("href", "#")
                    .attr("id", function(d) { return d; })
                    .classed("disabled", function(d) {
                        return !geo.hasOwnProperty(d);
                    })
                    .on("click", function(d) {
                        if (geo.hasOwnProperty(d)) {
                            delete parameters.i;
                            info.update();
                            loadData(d);
                        }
                    })
                    .text(function(d) { return d; });

                // Join tra dati e territori
                function joinData(territorio) {
                    var numGeo = geo[territorio].resource.features.length,
                        numData = data[territorio].resource.result.records.length,
                        noData = true, numOkData = 0, numNoData = 0;
                    for (var i=0; i<geo[territorio].resource.features.length; i++) {
                        var geoID = geo[territorio].resource.features[i].properties[geo[territorio].id];
                        for (var j=0; j<numData; j++) {
                            var dataID = data[territorio].resource.result.records[j][data[territorio].id];
                            if (dataID == geoID) {
                                numOkData++;
                                geo[territorio].resource.features[i].properties.data = data[territorio].resource.result.records[j];
                                noData = false;
                                break;
                            }
                        }
                        if (noData) {
                            numNoData++;
                            geo[territorio].resource.features.splice(i,1);
                            i--;
                        } else {
                            noData = true;
                        }
                    }
                }

                // Binning della distribuzione dei dati
                function binData(territorio) {
                    var serie = data[territorio].resource.result.records.map(function(el) { return parseInt(el[data[territorio].binCol]); });
                    var gs = new geostats(serie);
                    data[territorio].bins = gs.getJenks(serie.length > 7 ? 7 : serie.length-1);
                    data[territorio].ranges = gs.ranges;
                    legend.update(territorio);
                }

                // Caricamente asincrono dei dati
                function loadData(territorio) { // territorio = regioni || province || comuni
                    d3.selectAll("nav#menu-ui a").classed("active", false);
                    d3.select("nav#menu-ui a#"+territorio).classed("active", true);
                    parameters.dl = territorio;
                    geojson.clearLayers();
                    if (!geo[territorio].resource || !data[territorio].resource) {
                        var limit = 5000,
                            geoPath = 'geo/' + 
                                (parameters.t ? (territorio + '-' + parameters.t) : territorio) + 
                                '.js',
                            dataPath = apiPath + 
                                '?resource_id=' + data[territorio].resourceId + 
                                (parameters.t ? ('&filters[' + defaultData[parameters.fl].id + ']=' + parameters.t) : ""); 
                        map.spin(true);
                        queue()
                            .defer(d3.json, geoPath) // Geojson
                            .defer(d3.json, dataPath + '&limit=' + limit) // Dati
                            .await(function(err, geojs, datajs) {
                                geo[territorio].resource = geojs;
                                data[territorio].resource = datajs;
                                map.spin(false);
                                /*if (territorio == 'comuni') {
                                    JSTERS['comuni'] = geo['comuni'].resource.features.map(function(el) { var arr = {}; arr[geo['regioni'].id] = el.properties[geo['regioni'].id]; arr[geo['province'].id] = el.properties[geo['province'].id]; arr[geo['comuni'].id] = el.properties[geo['comuni'].id]; arr[geo['comuni'].name] = el.properties[geo['comuni'].name]; return arr; });
                                }*/
                                joinData(territorio);
                                binData(territorio);
	        	    	        geojson.addData(geo[territorio].resource);
                                if (parameters.t) { map.fitBounds(geojson.getBounds()); }
                                if (parameters.i) {
                                    geojson.eachLayer(function(l) { 
                                        if (l.feature.properties[geo[territorio].id] == parameters.i) {
                                            openInfoWindow(null, l);
                                        }
                                    });
                                }
                            });
                    } else {
                        geojson.addData(geo[territorio].resource);
                        delete parameters.i;
                        info.update();
                    }
                }
                /*** ***/

                /*** Inizializzazione ***/
                setTimeout(function () {
                    map.spin(false);
                    loadData(parameters.dl);
                }, 3000);
                /*** ***/

            });

        </script>
    </head>
    <body>
        <div id="fb-root"></div>
        <div id="map"></div>
    </body>
</html>

